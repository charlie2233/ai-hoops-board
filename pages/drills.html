<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>训练库</title>
<meta name="theme-color" content="#f4f7ff"/>
<script>
(() => {
  try {
    const t = localStorage.getItem('uiThemeV1');
    if (t === 'light' || t === 'dark') document.documentElement.setAttribute('data-theme', t);
    const s = localStorage.getItem('uiThemeStyleV1');
    if (s === 'classic' || s === 'vivid') document.documentElement.setAttribute('data-style', s);
  } catch (_) {}
})();
</script>
<style>
  :root{
    --bg:#f3f7ff;
    --bg-soft:#edf3ff;
    --panel:rgba(255,255,255,.8);
    --panel-strong:rgba(255,255,255,.92);
    --ink:#0f172a;
    --muted:#64748b;
    --line:#d7dff3;
    --line-strong:#becae6;
    --accent:#ea580c;
    --accent-soft:#fb923c;
    --shadow:0 14px 36px rgba(15,23,42,.08);
    --font-main:"Avenir Next", "Trebuchet MS", "Segoe UI", "PingFang SC", "Noto Sans SC", sans-serif;
    --font-title:"Avenir Next Condensed", "Trebuchet MS", "PingFang SC", sans-serif;
  }

  :root[data-theme="dark"]{
    --bg:#0b1220;
    --bg-soft:#111a2d;
    --panel:rgba(15,23,42,.78);
    --panel-strong:rgba(15,23,42,.92);
    --ink:#e2e8f0;
    --muted:#94a3b8;
    --line:#25324d;
    --line-strong:#3a4a6b;
    --accent:#fb923c;
    --accent-soft:#f97316;
    --shadow:0 18px 44px rgba(2,6,23,.45);
  }

  :root[data-style="vivid"]{
    --bg:#fff8ef;
    --bg-soft:#ffe9d6;
    --panel:rgba(255,250,243,.8);
    --panel-strong:rgba(255,250,243,.92);
    --ink:#1f2937;
    --muted:#7c5c3d;
    --line:#f2c7a7;
    --line-strong:#e8a87f;
    --accent:#0f766e;
    --accent-soft:#14b8a6;
    --shadow:0 16px 38px rgba(15,118,110,.15);
  }

  :root[data-theme="dark"][data-style="vivid"]{
    --bg:#0f172a;
    --bg-soft:#111827;
    --panel:rgba(17,24,39,.78);
    --panel-strong:rgba(17,24,39,.92);
    --ink:#ecfeff;
    --muted:#93c5fd;
    --line:#234059;
    --line-strong:#2f5f87;
    --accent:#14b8a6;
    --accent-soft:#2dd4bf;
    --shadow:0 18px 44px rgba(15,118,110,.35);
  }

  *{box-sizing:border-box}
  html,body{margin:0;min-height:100%}
  body{
    font-family:var(--font-main);
    color:var(--ink);
    background:
      radial-gradient(980px 540px at -12% -20%, color-mix(in srgb, var(--accent-soft) 26%, transparent), transparent 70%),
      radial-gradient(920px 520px at 108% -15%, color-mix(in srgb, #06b6d4 20%, transparent), transparent 70%),
      linear-gradient(165deg,var(--bg),var(--bg-soft));
    background-attachment:fixed;
  }

  .appbar{
    position:sticky;top:0;z-index:20;
    display:flex;justify-content:space-between;align-items:center;gap:10px;
    padding:12px 14px;
    border-bottom:1px solid var(--line);
    background:color-mix(in srgb,var(--panel-strong) 92%, transparent);
    backdrop-filter:blur(8px);
  }
  .appbar a{color:var(--ink);text-decoration:none;font-size:13px;font-weight:700}
  h1{font:700 20px/1.1 var(--font-title);margin:0}
  .sub{font-size:12px;color:var(--muted);margin-top:2px}

  .appbar-right{display:flex;align-items:center;gap:8px}
  .theme-switch{display:flex;gap:4px;padding:4px;border:1px solid var(--line);border-radius:999px;background:color-mix(in srgb,var(--panel) 86%, transparent)}
  .theme-btn{height:30px;min-width:52px;border:0;border-radius:999px;background:transparent;color:var(--muted);font-size:12px;font-weight:700;cursor:pointer}
  .theme-btn.active{background:linear-gradient(135deg,var(--accent),var(--accent-soft));color:#fff;box-shadow:0 6px 14px color-mix(in srgb,var(--accent) 36%, transparent)}
  .style-switch{display:flex;gap:4px;padding:4px;border:1px solid var(--line);border-radius:999px;background:color-mix(in srgb,var(--panel) 86%, transparent)}
  .style-btn{height:30px;min-width:52px;border:0;border-radius:999px;background:transparent;color:var(--muted);font-size:12px;font-weight:700;cursor:pointer}
  .style-btn.active{background:linear-gradient(135deg,var(--accent),var(--accent-soft));color:#fff;box-shadow:0 6px 14px color-mix(in srgb,var(--accent) 36%, transparent)}

  .filters{
    position:sticky;top:66px;z-index:19;
    display:grid;grid-template-columns:minmax(220px,1fr) 180px;gap:8px;
    padding:10px 12px;
    border-bottom:1px solid var(--line);
    background:color-mix(in srgb,var(--panel) 90%, transparent);
    backdrop-filter:blur(8px);
  }
  .ctrl{height:40px;border:1px solid var(--line);border-radius:12px;padding:0 10px;background:color-mix(in srgb,var(--panel-strong) 88%, transparent);color:var(--ink);font-size:13px;font-weight:600}

  .player{
    position:sticky;top:124px;z-index:18;
    margin:10px 12px 0;padding:10px;
    border:1px solid var(--line);border-radius:14px;
    background:color-mix(in srgb,var(--panel-strong) 94%, transparent);
    box-shadow:var(--shadow);
  }
  .player[hidden]{display:none}
  .player-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
  .player-title{font-size:14px;font-weight:800}
  .player-actions{display:flex;gap:8px}
  .ghost{height:34px;border:1px solid var(--line);border-radius:10px;background:color-mix(in srgb,var(--panel) 90%, transparent);color:var(--ink);padding:0 10px;cursor:pointer;font-weight:700}
  .frame{position:relative;padding-top:56.25%;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#111827}
  .frame iframe{position:absolute;inset:0;width:100%;height:100%;border:0}

  .list{padding:14px;display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px}
  .card{
    --d:0;
    border:1px solid var(--line);border-radius:16px;padding:12px;
    background:linear-gradient(170deg,color-mix(in srgb,var(--panel-strong) 90%, transparent),color-mix(in srgb,var(--panel) 86%, transparent));
    box-shadow:var(--shadow);
    display:flex;gap:12px;
    animation:rise .45s ease both;
    animation-delay:calc(var(--d) * 42ms);
    transition:transform .2s ease,border-color .2s ease;
  }
  .card:hover{transform:translateY(-2px);border-color:var(--line-strong)}
  .thumb{width:172px;height:96px;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#f8fafc;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px;flex:0 0 auto}
  .title{font-size:16px;font-weight:800;line-height:1.2}
  .meta{font-size:12px;color:var(--muted);margin-top:4px}
  .row{display:flex;gap:8px;margin-top:8px}
  .btn{height:38px;border-radius:10px;border:1px solid var(--line);background:color-mix(in srgb,var(--panel-strong) 90%, transparent);color:var(--ink);padding:0 10px;font-weight:700;cursor:pointer}
  .btn.play{border:0;background:linear-gradient(135deg,var(--accent),var(--accent-soft));color:#fff}
  .btn.apply{background:color-mix(in srgb,var(--panel) 90%, transparent)}
  .empty{padding:28px 10px;color:var(--muted);text-align:center}

  @keyframes rise{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

  @media (max-width:820px){
    .theme-btn,.style-btn{min-width:44px;font-size:11px}
    .sub{display:none}
    h1{font-size:18px}
    .filters{grid-template-columns:1fr}
    .player{top:168px}
  }
  @media (max-width:700px){
    .card{flex-direction:column}
    .thumb{width:100%;height:180px}
    .row{flex-wrap:wrap}
  }
</style>
</head>
<body>
  <div class="appbar">
    <div>
      <a href="../index.html">← 返回画板</a>
      <h1>训练库</h1>
      <div class="sub">Drill Library</div>
    </div>
    <div class="appbar-right">
      <div class="theme-switch" role="group" aria-label="主题切换">
        <button class="theme-btn" id="theme-light" aria-pressed="false">浅色</button>
        <button class="theme-btn" id="theme-dark" aria-pressed="false">深色</button>
      </div>
      <div class="style-switch" role="group" aria-label="样式切换">
        <button class="style-btn" id="style-classic" aria-pressed="false">经典</button>
        <button class="style-btn" id="style-vivid" aria-pressed="false">动感</button>
      </div>
    </div>
  </div>

  <div class="filters">
    <input id="q" class="ctrl" placeholder="搜索训练/要点/标签…"/>
    <select id="fPlay" class="ctrl"><option value="">关联战术</option></select>
  </div>

  <div class="player" id="player" hidden>
    <div class="player-head">
      <div class="player-title" id="player-title">训练视频</div>
      <div class="player-actions">
        <button class="ghost" id="player-open">在 YouTube 打开</button>
        <button class="ghost" id="player-close">关闭</button>
      </div>
    </div>
    <div class="frame">
      <iframe id="player-frame" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
    </div>
  </div>

  <div class="list" id="list"></div>

<script>
const THEME_KEY = 'uiThemeV1';
const THEME_STYLE_KEY = 'uiThemeStyleV1';
const RECENTS_KEY = 'playRecentsV1';
const themeButtons = {
  light: document.getElementById('theme-light'),
  dark: document.getElementById('theme-dark')
};
const styleButtons = {
  classic: document.getElementById('style-classic'),
  vivid: document.getElementById('style-vivid')
};
const themeColorMeta = document.querySelector('meta[name="theme-color"]');

function normalizeTheme(theme){
  return theme === 'dark' ? 'dark' : 'light';
}

function normalizeStyle(style){
  return style === 'vivid' ? 'vivid' : 'classic';
}

function updateThemeColorMeta(theme = normalizeTheme(document.documentElement.getAttribute('data-theme')),
  style = normalizeStyle(document.documentElement.getAttribute('data-style'))){
  if (!themeColorMeta) return;
  if (theme === 'dark'){
    themeColorMeta.setAttribute('content', style === 'vivid' ? '#0f172a' : '#0b1220');
  } else {
    themeColorMeta.setAttribute('content', style === 'vivid' ? '#fff8ef' : '#f4f7ff');
  }
}

function refreshThemeButtons(theme){
  const t = normalizeTheme(theme);
  Object.entries(themeButtons).forEach(([k, el]) => {
    if (!el) return;
    const active = k === t;
    el.classList.toggle('active', active);
    el.setAttribute('aria-pressed', active ? 'true' : 'false');
  });
}

function refreshStyleButtons(style){
  const s = normalizeStyle(style);
  Object.entries(styleButtons).forEach(([k, el]) => {
    if (!el) return;
    const active = k === s;
    el.classList.toggle('active', active);
    el.setAttribute('aria-pressed', active ? 'true' : 'false');
  });
}

function applyTheme(theme, persist = true){
  const t = normalizeTheme(theme);
  document.documentElement.setAttribute('data-theme', t);
  refreshThemeButtons(t);
  updateThemeColorMeta(t);
  if (persist){
    try { localStorage.setItem(THEME_KEY, t); } catch (_) {}
  }
}

function applyThemeStyle(style, persist = true){
  const s = normalizeStyle(style);
  document.documentElement.setAttribute('data-style', s);
  refreshStyleButtons(s);
  updateThemeColorMeta(undefined, s);
  if (persist){
    try { localStorage.setItem(THEME_STYLE_KEY, s); } catch (_) {}
  }
}

function initThemeSwitch(){
  let savedTheme = null;
  let savedStyle = null;
  try {
    savedTheme = localStorage.getItem(THEME_KEY);
    savedStyle = localStorage.getItem(THEME_STYLE_KEY);
  } catch (_) {}
  applyTheme(savedTheme || document.documentElement.getAttribute('data-theme') || 'light', false);
  applyThemeStyle(savedStyle || document.documentElement.getAttribute('data-style') || 'classic', false);
  if (themeButtons.light) themeButtons.light.onclick = () => applyTheme('light');
  if (themeButtons.dark) themeButtons.dark.onclick = () => applyTheme('dark');
  if (styleButtons.classic) styleButtons.classic.onclick = () => applyThemeStyle('classic');
  if (styleButtons.vivid) styleButtons.vivid.onclick = () => applyThemeStyle('vivid');
}

let drills = [];
let plays = [];
let activeVideoId = '';

function escapeHtml(s){
  return String(s || '')
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function encodeAttr(s){
  return encodeURIComponent(String(s || ''));
}

function decodeAttr(s){
  try { return decodeURIComponent(s || ''); } catch(_) { return ''; }
}

async function load(){
  plays = await (await fetch('../plays/plays.json?t=' + Date.now(), { cache: 'no-store' })).json();
  drills = await (await fetch('../drills/drills.json?t=' + Date.now(), { cache: 'no-store' })).json();

  const sel = document.getElementById('fPlay');
  plays.forEach(p => {
    const op = document.createElement('option');
    op.value = p.id;
    op.textContent = p.name;
    sel.appendChild(op);
  });
  render();
}

function match(d, q, pid){
  const text = (d.title + ' ' + (d.notes || '') + ' ' + (d.tags || []).join(' ')).toLowerCase();
  const qok = !q || text.includes(q.toLowerCase());
  const pok = !pid || d.playId === pid;
  return qok && pok;
}

function ytThumb(id){
  if (!id || id.startsWith('VIDEO_ID_')) return '';
  return `https://i.ytimg.com/vi/${id}/hqdefault.jpg`;
}

function render(){
  const q = document.getElementById('q').value.trim();
  const pid = document.getElementById('fPlay').value;
  const list = document.getElementById('list');

  const html = drills.filter(d => match(d, q, pid)).map((d, idx) => {
    const thumb = ytThumb(d.youtubeId);
    const playName = (plays.find(p => p.id === d.playId) || {}).name || d.playId || '-';
    return `
      <div class="card" style="--d:${idx % 10}">
        <div class="thumb">
          ${thumb ? `<img src="${thumb}" alt="" style="width:100%;height:100%;object-fit:cover"/>` : '占位缩略图'}
        </div>
        <div style="flex:1">
          <div class="title">${escapeHtml(d.title)}</div>
          <div class="meta">${escapeHtml(d.duration || '')} · 关联：${escapeHtml(playName)} · 标签：${escapeHtml((d.tags || []).join('/'))}</div>
          <div class="meta">要点：${escapeHtml(d.notes || '')}</div>
          <div class="row">
            <button class="btn play js-play"
              data-video-id="${encodeAttr(d.youtubeId || '')}"
              data-title="${encodeAttr(d.title || '')}">播放</button>
            <button class="btn apply js-apply-play"
              data-play-id="${encodeAttr(d.playId || '')}">应用关联战术</button>
          </div>
        </div>
      </div>`;
  }).join('');

  list.innerHTML = html || '<div class="empty">没有匹配的训练</div>';
}

function closePlayer(){
  const frame = document.getElementById('player-frame');
  frame.src = 'about:blank';
  activeVideoId = '';
  document.getElementById('player').hidden = true;
}

function playVideo(id, title){
  if (!id || id.startsWith('VIDEO_ID_')){
    alert('占位ID，请替换为真实的 YouTube 视频ID');
    return;
  }
  activeVideoId = id;
  document.getElementById('player-title').textContent = title ? ('正在播放：' + title) : '正在播放训练视频';
  document.getElementById('player-frame').src = `https://www.youtube-nocookie.com/embed/${id}?autoplay=1&rel=0&modestbranding=1`;
  document.getElementById('player').hidden = false;
}

function markRecent(playId){
  const pid = String(playId || '').trim();
  if (!pid) return;
  let list = [];
  try {
    const raw = JSON.parse(localStorage.getItem(RECENTS_KEY) || '[]');
    if (Array.isArray(raw)) list = raw.map(x => String(x || '').trim()).filter(Boolean);
  } catch (_) {}
  const next = [pid, ...list.filter(x => x !== pid)].slice(0, 24);
  try { localStorage.setItem(RECENTS_KEY, JSON.stringify(next)); } catch (_) {}
}

function applyPlay(playId){
  if (!playId) return;
  markRecent(playId);
  try { localStorage.setItem('applyPlayId', playId); } catch(_) {}
  location.href = '../index.html?apply=' + encodeURIComponent(playId);
}

document.getElementById('q').oninput = render;
document.getElementById('fPlay').onchange = render;
document.getElementById('player-close').onclick = closePlayer;
document.getElementById('player-open').onclick = () => {
  if (!activeVideoId) return;
  window.open(`https://www.youtube.com/watch?v=${activeVideoId}`, '_blank');
};

document.getElementById('list').addEventListener('click', (e) => {
  const playBtn = e.target.closest('.js-play');
  if (playBtn){
    const videoId = decodeAttr(playBtn.dataset.videoId);
    const title = decodeAttr(playBtn.dataset.title);
    playVideo(videoId, title);
    return;
  }
  const applyBtn = e.target.closest('.js-apply-play');
  if (applyBtn){
    const playId = decodeAttr(applyBtn.dataset.playId);
    applyPlay(playId);
  }
});

initThemeSwitch();
load();
</script>
</body>
</html>
